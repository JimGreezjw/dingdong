var ddpatientApp=angular.module("ddpatientApp",["ionic","ddpatientFilters","ddpatientControllers","ddChatController","ddpatientServices","ddpatientDirectives"]);ddpatientApp.run(["$ionicPlatform",function(e){e.ready(function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault()})}]).config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider",function(e,t,r){r.templates.maxPrefetch(0),e.state("tab",{url:"/tab","abstract":!0,templateUrl:"templates/tabs.html",controller:"TabsCtrl"}).state("tab.main",{url:"/main",views:{"tab-main":{templateUrl:"templates/tab-main.html",controller:"MainCtrl"}}}).state("tab.hosipitals",{url:"/hospitalsAll",views:{"tab-hosipitals":{templateUrl:"templates/hospital/hospitals.html",controller:"HospitalsAllCtrl"}}}).state("tab.doctorsFan",{url:"/doctorsFan",views:{"tab-doctorsFan":{templateUrl:"templates/tab-doctorsFan.html",controller:"DoctorsFanCtrl"}}}).state("tab.account",{url:"/account",views:{"tab-account":{templateUrl:"templates/tab-account.html",controller:"accountCtrl"}}}),e.state("newpatitent",{url:"/newpatient/:scheduleId/:doctorId/:type",templateUrl:"templates/newpatient.html",controller:"newPatientCtrl"}),e.state("doctorList",{url:"/doctorList",templateUrl:"templates/doctorList.html",controller:"DoctorsCtrl"}).state("doctorDeptList",{url:"/doctorDeptList/:deptId",templateUrl:"templates/doctor/doctorDeptList.html",controller:"DoctorDeptListCtrl"}).state("deptListAll",{url:"/deptListAll",templateUrl:"templates/doctor/deptListShow.html",controller:"deptListAllCtrl"}).state("doctorListShow",{url:"/doctorListShow",templateUrl:"templates/doctor/doctorDeptList.html",controller:"DoctorDeptListCtrl"}).state("hospitalDoctorList",{url:"/hospitalDoctorList/:hospitalId",templateUrl:"templates/hospital/hospitalDoctorList.html",controller:"hospitalDoctorsCtrl"}).state("doctorSearchList",{url:"/doctorSearchList/:filterText",templateUrl:"templates/doctor/doctorSearchList.html",controller:"DoctorsSearchListCtrl"}).state("doctor-detail",{url:"/doctors/:doctorId/hospital/:hospitalId",templateUrl:"templates/doctor-detail.html",controller:"DoctorDetailCtrl"}).state("tab.doctor-detail-history",{url:"/doctor-detail-history/:doctorId",views:{"tab-account":{templateUrl:"templates/doctor-detail.html",controller:"DoctorDetailCtrl"}}}).state("doctor-infor",{url:"/doctors/:doctorId/doctorInfor",templateUrl:"templates/doctor-infor.html",controller:"DoctorInforCtrl"}).state("user-patient-account",{url:"/userPatientAccount/:type",templateUrl:"templates/patient/user-patient-account.html",controller:"UserPatientCtrl"}).state("user-patient-add-main",{url:"/userPatientAddMain",templateUrl:"templates/patient/user-patient-add.html",controller:"UserPatientAddCtrl"}).state("user-patient-add-account",{url:"/userPatientAddAccount/:type",templateUrl:"templates/patient/user-patient-add.html",controller:"UserPatientAddCtrl"}).state("doctor-infor-show",{url:"/doctors/:doctorId/doctorInforShow",templateUrl:"templates/doctor/doctor-infor-show.html",controller:"DoctorInforCtrl"}).state("doctor-infor-share",{url:"/doctors/:doctorId/doctorInforShare",templateUrl:"templates/doctor/doctor-infor-share.html",controller:"DoctorInforShareCtrl"}).state("tab.hospital-infor",{url:"/hospitals/:doctorId",views:{"tab-main":{templateUrl:"templates/hospitallist.html",controller:"hospitalCtrl"}}}).state("hospital-introduction",{url:"/hospitals/:hospitalId/hospitalIntro",cache:!0,templateUrl:"templates/hospital/hospitals_infor_show.html",controller:"hospitalIntroCtrl"}).state("doctorHospitals",{url:"/doctorHospitals/:doctorId",templateUrl:"templates/doctor/doctorHospitalList.html",controller:"doctorHospitalsCtrl"}).state("tab.doctor-detail-funs",{url:"/doctor-detail-funs/:doctorId",views:{"tab-doctorsFan":{templateUrl:"templates/doctorFun/doctor-detail-funs.html",controller:"DoctorDetailCtrl"}}}).state("tab.hospital-doctorsFan",{url:"/hospitals-doctorsFan/:doctorId",views:{"tab-doctorsFan":{templateUrl:"templates/hospitallist.html",controller:"hospitalCtrl"}}}).state("tab.doctor-infor-funs",{url:"/doctors-funs/:doctorId/doctorInfor",views:{"tab-doctorsFan":{templateUrl:"templates/doctorFun/doctor-infor-funs.html",controller:"DoctorInforCtrl"}}}).state("tab.userQueue",{url:"/user/userQueue",views:{"tab-account":{templateUrl:"templates/userQueueList.html",controller:"userQueueCtrl"}}}).state("tab.userRegister",{url:"/user/userRegister",views:{"tab-account":{templateUrl:"templates/userRegisterList.html",controller:"userRegisterCtrl"}}}).state("tab.userAfterRegister",{url:"/user/userAfterRegister",views:{"tab-main":{templateUrl:"templates/userRegisterList.html",controller:"userRegisterCtrl"}}}).state("tab.userRegisterHistory",{url:"/user/userRegisterHistory",views:{"tab-account":{templateUrl:"templates/userRegisterHistoryList.html",controller:"userRegisterHistoryCtrl"}}}).state("doctorEvaluationList",{url:"/user/doctorEvaluationList/:doctorId",templateUrl:"templates/doctor/doctorEvaluationListShow.html",controller:"doctorEvaluationListCtrl"}).state("tab.myEvaluationList",{url:"/user/myEvaluationList/:userId/:registerId/:doctorId",views:{"tab-account":{templateUrl:"templates/evaluation/evaluation-list.html",controller:"myEvaluationListCtrl"}}}).state("tab.needEvaluationList",{url:"/user/needEvaluationList",views:{"tab-account":{templateUrl:"templates/evaluation/tab-evaluation-list.html",controller:"needEvaluationListCtrl"}}}).state("addEvaluation",{url:"/user/addEvaluation/:registerId",templateUrl:"templates/evaluation/add-evaluation.html",controller:"addEvaluationCtrl"}).state("tab.userRegisterConfirm",{url:"/user/register/userRegisterConfirm",views:{"tab-account":{templateUrl:"templates/register/userRegisterConfirmList.html",controller:"UserRegisterConfirmListCtrl"}}}).state("tab.score",{url:"/user/score",views:{"tab-account":{templateUrl:"templates/account/tab-score.html",controller:"ScoreCtrl"}}}).state("scoreTerms",{url:"/scoreTerms",cache:!0,templateUrl:"templates/transfers/score-terms.html",controller:""}).state("accountList",{url:"/accountList",templateUrl:"templates/transfers/accounts-list.html",controller:"AccountListCtrl"}).state("getAccount",{url:"/accountList/:operationType",templateUrl:"templates/transfers/accounts-list.html",controller:"AccountListCtrl"}).state("cashApply",{url:"/cashApply",templateUrl:"templates/wxpay/cashApply.html",controller:""}).state("addAccount",{url:"/addAccount",templateUrl:"templates/transfers/add-account.html",controller:"AddAccountCtrl"}).state("terms",{url:"/user/terms",cache:!0,templateUrl:"templates/terms.html",controller:"TermsCtrl"}).state("userTransfer",{url:"/userTransfer/:transferType",templateUrl:"templates/transfers/user-transfers.html",controller:"UserTransferCtrl"}).state("tab.smsValid",{url:"/user/smsValid",templateUrl:"templates/smsValid.html",controller:"SmsValidCtrl"}).state("wxpay",{url:"/user/wxpay",templateUrl:"templates/wxpay/tab-wxpay.html",controller:"WxpayCtrl"}).state("wxpayRecharge",{url:"/user/wxpay/recharge",templateUrl:"templates/wxpay/userRecharge.html",controller:"WxpayRechargeCtrl"}).state("userInformation",{url:"/user/userInformation",templateUrl:"templates/user-information.html",controller:"UserInformationCtrl"}).state("user-patient-main",{url:"/userPatientMain/:type",templateUrl:"templates/patient/user-patient-main.html",controller:"UserPatientCtrl"}).state("tab.user-patient-main-confirm",{url:"/userPatientMainConfirm/:type",views:{"tab-account":{templateUrl:"templates/patient/user-patient-main.html",controller:"UserPatientCtrl"}}}).state("tab.patients-history-detail",{url:"/patientHistory/:patientId/:registerId",views:{"tab-account":{templateUrl:"templates/patient/patient-history-detail.html",controller:"PatientDetailCtrl"}}}).state("enchashment",{url:"/enchashment",templateUrl:"templates/wxpay/enchashment.html",controller:"EnchashmentCtrl"}).state("userSetting",{url:"/user/setting",templateUrl:"templates/userSetting.html",controller:"UserSettingCtrl"}).state("userChat",{url:"/userChat/:ddUserId/:doctorId",templateUrl:"templates/chat/chat-user.html",controller:"ChatMessagesCtrl"}).state("userChatRoom",{url:"/tab/userChat",templateUrl:"templates/chat/chatRoom.html",controller:"ChatRoomCtrl"}),t.otherwise("/tab/main"),r.backButton.text("").icon("ion-chevron-left"),r.tabs.style("standard"),r.tabs.position("bottom"),r.views.transition("none"),r.scrolling.jsScrolling(!1)}]);var ddpatientControllers=angular.module("ddpatientControllers",["ionic-datepicker","ngCookies"]);ddpatientControllers.config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*(https?|local|data|http|weixin):/)}]),ddpatientControllers.controller("MainCtrl",["$scope","$rootScope","$location","$cookies","$cookieStore","$ionicLoading","$timeout","userFansServices","ddJsConfig","getRegisterByStatusServices","ddUserServices","userQueueServices","doctorServices","registerUnFinishedServices","userInforList","doctorNewJoinServices",function(e,t,r,o,s,n,i,a,c,d,l,u,p,f,g,m){!function(){var e=window.location.href;e=e.substring(0,e.indexOf("#")),c.jsConfig({url:e},function(e){var t=e;wx.config({debug:!1,appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","chooseImage","previewImage","uploadImage","downloadImage","chooseWXPay"]})})}();var h=e.ddUserId=o.get("userId");e.ctrlScope=e,g.hasOwnProperty("userId")||(g.userId=h),a.get({id:h},function(e){g.fanDoctorList=e.doctors}),e.$on("$ionicView.enter",function(e){}),e.search=function(){var e;e="/doctorList",r.url(e)}}]).controller("TabsCtrl",["$scope","$rootScope","$timeout","$interval","userInforList","ddUserServices",function(e,t,r,o,s,n){}]).controller("accountCtrl",["$scope","$rootScope","$timeout","$interval","doctorUtils","userQueueServices","getRegisterByStatusServices","getRegisterByStatusServices","userInforList","ddUserServices",function(e,t,r,o,s,n,i,i,a,c){var d;a.hasOwnProperty("userId")?d=a.userId:(d=s.getCookies("userId"),a.userId=d),e.ctrlScope=e;var l=function(){d&&c.get({userId:d},function(t){var r=t.users[0];r&&(e.user=t.users[0],e.ctrlScope.name=r.name,e.ctrlScope.balance=r.balance,e.ctrlScope.score=r.score,e.ctrlScope.address=r.address,e.ctrlScope.gender=r.gender,e.ctrlScope.phone=r.phone,e.ctrlScope.certificateId=r.certificateId,e.ctrlScope.headImgUrl=r.headImgUrl,e.ctrlScope.phoneOld=r.phone)})},u=function(){d&&i.get({userId:d,status:-1},function(t){a.queues=t.registers,e.queuesCount=a.queues.length})},p=function(){d&&i.getRegisterByStatus({userId:d,status:1},function(t){a.registers=t.registers,e.registerCount=a.registers.length})},f=function(){d&&i.getRegisterByStatus({userId:d,status:3},function(t){a.needEvaluation=t.registers,e.needEvaluationCount=a.needEvaluation.length})},g=function(){d&&i.getRegisterByStatus({userId:d,status:5},function(t){a.registersHistorys=t.registers,e.registerHistoryCount=a.registersHistorys.length})};e.$on("$ionicView.enter",function(e){l(),u(),p(),f(),g()}),e.doRefresh=function(){r(function(){l(),u(),p(),f(),g(),e.$broadcast("scroll.refreshComplete")},1e3)}}]).controller("DoctorsCtrl",["$scope","$rootScope","$ionicPopover","$location","$timeout","$ionicHistory","doctorServices","ddGetDoctorsByNameOrSpecialty","ddGetDoctorsByNameOrSpecialty","userFansServices","userInforList",function(e,t,r,o,s,n,i,a,a,c,d){e.ctrlScope=e;d.userId;e.$on("$ionicView.enter",function(e){});var l=function(){i.queryAll({size:"10000",page:"1",orderBy:"name",order:"ASC"},function(t){e.doctors=t.doctors})};l(),e.doRefresh=function(){s(function(){l(),e.$broadcast("scroll.refreshComplete")},1e3)},e.getHospital=function(e){d.doctor=e;var t="#/doctorHospitals/"+e.id;o.url(t)},e.goBack=function(){n.goBack(-1)}}]).controller("DoctorDeptListCtrl",["$scope","$rootScope","$ionicPopover","$location","$timeout","$ionicHistory","$stateParams","doctorServices","ddGetDoctorsByNameOrSpecialty","ddGetDoctorsByNameOrSpecialty","userFansServices","userInforList","topDeptServices","doctorDeptDoctorsServices",function(e,t,r,o,s,n,i,a,c,c,d,l,u,p){e.ctrlScope=e;var f=(l.userId,i.deptId);e.$on("$ionicView.enter",function(e){});var g=function(){p.get({id:f},function(t){"OK"==t.responseDesc&&(e.doctors=t.doctors)})};g(),e.doRefresh=function(){s(function(){g(),e.$broadcast("scroll.refreshComplete")},1e3)},e.getHospital=function(e){l.doctor=e;var t="#/doctorHospitals/"+e.id;o.url(t)},e.goBack=function(){n.goBack(-1)}}]).controller("deptListAllCtrl",["$scope","$rootScope","$ionicPopover","$location","$timeout","$ionicHistory","$stateParams","doctorServices","ddGetDoctorsByNameOrSpecialty","ddGetDoctorsByNameOrSpecialty","userFansServices","userInforList","topDeptServices","subDeptServices",function(e,t,r,o,s,n,i,a,c,c,d,l,u,p){e.ctrlScope=e;l.userId;e.$on("$ionicView.enter",function(e){});var f=function(){u.get({},function(t){"OK"==t.responseDesc&&(e.depts=t.depts)})};f(),getSubDepts=e.getSubDepts=function(t,r){e.selectedIndex=t,p.get({parentId:r},function(t){if("OK"==t.responseDesc&&t.depts.length>0)e.subDepts=t.depts;else{var s;s="/doctorDeptList/"+r,o.url(s)}})},getSubDepts(0,1),e.goBack=function(){n.goBack(-1)}}]).controller("DoctorsSearchListCtrl",["$scope","$rootScope","$stateParams","$ionicPopover","$location","$ionicHistory","$timeout","ddGetDoctorsByNameOrSpecialty","userFansServices","userInforList",function(e,t,r,o,s,n,i,a,c,d){e.ctrlScope=e;d.userId;e.goBack=function(){n.goBack(-1)},e.$on("$ionicView.enter",function(e){}),e.viewStatus=1;var l=e.vm={doctors:[],pagination:{perPage:15,currentPage:1},search:function(){a.getDoctorsByNameOrSpecialty({filterText:l.query,size:l.pagination.perPage,page:l.pagination.currentPage,orderBy:"name",order:"ASC"},function(t){t.doctors.length>0&&(l.doctors=t.doctors,e.viewStatus=2)})}}}]).controller("DoctorsFanCtrl",["$scope","$rootScope","$ionicPopup","$ionicPopover","$timeout","$stateParams","userFansServices","userInforList",function(e,t,r,o,s,n,i,a){var c=a.userId;e.doctors=[],e.$on("$ionicView.enter",function(t){e.doctors=a.fanDoctorList});e.remove=function(t){var o='<h4 style=" text-align:center;">'+t.name+"<br/>"+t.hospitalName+"</h4>",s=r.confirm({title:"<h4 >确认取消关注吗？</h4>",template:o,cancelText:"取消",okText:"确定"});s.then(function(r){r&&i.remove({id:c,doctorId:t.id},function(r){var o=a.fanDoctorList.filter(function(e,r,o){return e.id!=t.id});a.fanDoctorList=o,e.doctors=a.fanDoctorList})})}}]).controller("DoctorDetailCtrl",["$scope","$rootScope","$ionicHistory","$location","$stateParams","$filter","$ionicPopup","scheduleServices","dateFilter","ddGetDoctorQueuesServices","doctorServices","ddGetDoctorScheduleDateServices","doctorInforList","scheduleOnedayServices","ddUserServices","scheduleUserServices","userInforList",function(e,t,r,o,s,n,i,a,c,d,l,u,p,f,g,m,h){var v=h.userId;e.viewStatus=1;var S=e.schduleDateList=[];S=e.schduleDateList=p.schduleDateList;var I;l.queryAll({id:s.doctorId},function(t){e.doctor=t.doctors[0]}),e.scheduleShow=!1;var $=new Date,y=new Date($.getTime()+5184e6);e.calendar={},e.calendar.mode="month",f.query({doctorId:s.doctorId,hospitalId:s.hospitalId,beginDate:n("date")($,"yyyy-MM-dd"),endDate:n("date")(y,"yyyy-MM-dd")},function(t){e.schduleDateList=t.schedules,t.schedules>0&&angular.forEach(e.schduleDateList,function(t,r,o){e.schduleDateList[r].buttonValue="预约"})}),e.goBack=function(){r.goBack(-1)},e.$on("$ionicView.enter",function(e){}),e.onTimeSelected=function(t){var r=c(t,"yyyy-MM-dd");f.query({doctorId:s.doctorId,hospitalId:s.hospitalId,beginDate:r,endDate:r},function(t){I=e.schduleList=t.schedules,I.length>0&&(e.scheduleShow=!0,angular.forEach(e.schduleList,function(t,r,o){e.schduleList[r].buttonValue="预约"}))})},e.showSchedule=function(t){e.viewStatus=t};var w=function(e){var t=i.alert({template:'<h3 align="center">'+e+"</h3>",buttons:[{text:"确定",type:"button"}]});t.then(function(e){})};e.showConfirm=function(t,r,s,n){m.getScheduleUser({userId:v,scheduleId:r},function(t){if(e.registerSchedule=t.registers[0],t.registers[0])w("您已经预约过了，请勿重复预约！");else{var s="/newpatient/"+r+"/"+n+"/registerNew";o.url(s)}})}}]).controller("DoctorInforCtrl",["$scope","$ionicPopup","$rootScope","$ionicHistory","$location","$stateParams","$filter","doctorUtils","dateFilter","ddDoctorHospitalsServices","doctorServices","userFansServices","userInforList","showPopupServices","ddDoctorEvaluationsServices",function(e,t,r,o,s,n,i,a,c,d,l,u,p,f,g){var m,h,v=[];p.hasOwnProperty("userId")?h=p.userId:(h=a.getCookies("userId"),p.userId=h);var S=!1;wx.ready(function(e){S=!0}),S||a.wxInit();var I=function(){p.fanDoctorList?(v=p.fanDoctorList,v&&v.length>0&&v.forEach(function(t,r,o){t.id==n.doctorId&&(e.custom=!0)})):e.custom=!1};p.hasOwnProperty("fanDoctorList")?I():u.get({id:h},function(e){p.fanDoctorList=e.doctors,I()});var $=function(){l.queryAll({id:n.doctorId},function(t){m=e.doctor=t.doctors[0],e.doctors=t.doctors;var r={title:"为您推荐一个好大夫： "+m.name,desc:m.hospitalName+" "+m.deptName+" "+m.level+" "+m.teacherLevel+"  擅长："+m.specialty,link:"http://www.yushansoft.com/dingdong/v1/ddpatient/index.html#/doctors/"+m.id+"/doctorInforShare",imgUrl:m.headImgUrl,success:function(){},cancel:function(){},fail:function(e){alert("分享失败，请重新尝试")}};wx.ready(function(){wx.onMenuShareTimeline(r),wx.onMenuShareAppMessage(r)}),d.getDoctorHospitals({doctorId:n.doctorId,status:1},function(t){e.doctor.hospitals=t.doctorHospitals})})},y=function(){g.getDoctorEvaluations({doctorId:n.doctorId,size:3,page:1,order:"createTime",orderBy:"DESC"},function(t){t.doctorEvals&&t.doctorEvals.length>0&&(e.doctorEvals=t.doctorEvals)})};$(),y(),e.$on("$ionicView.enter",function(e){I()}),e.goBack=function(){o.viewHistory().backView?o.goBack(-1):s.url("/tab/main"),o.goBack(-1)},e.doctorFan=function(){u.save({id:h,doctorId:n.doctorId},function(t){"OK"==t.responseDesc&&p.fanDoctorList.push(t.doctors[0]),e.custom=e.custom===!1})},e.delFan=function(){u.remove({id:h,doctorId:n.doctorId},function(t){if("OK"==t.responseDesc){var r=p.fanDoctorList.filter(function(e,t,r){return e.id!=n.doctorId});p.fanDoctorList=r}e.custom=e.custom===!1})},e.registerDoc=function(){p.doctor=m;var e="/doctorHospitals/"+m.id;s.url(e)},e.shareFriends=function(){f.showAlert("推荐医生",'<h4 style=" text-align:center;">请点击 微信右上角 将'+m.name+"大夫推荐给好朋友吧！</h4>")}}]).controller("DoctorInforShareCtrl",["$scope","$ionicPopup","$rootScope","$ionicHistory","$location","$stateParams","$filter","doctorUtils","dateFilter","ddDoctorHospitalsServices","doctorServices","userFansServices","userInforList","showPopupServices","ddDoctorEvaluationsServices",function(e,t,r,o,s,n,i,a,c,d,l,u,p,f,g){var m;p.hasOwnProperty("userId")?m=p.userId:(m=a.getCookies("userId"),p.userId=m),a.wxInit();var h,v=function(){p.fanDoctorList?(h=p.fanDoctorList,h&&h.length>0&&h.forEach(function(t,r,o){t.id==n.doctorId&&(e.custom=!0)})):e.custom=!1};p.hasOwnProperty("fanDoctorList")?v():u.get({id:m},function(e){p.fanDoctorList=e.doctors,v()});var S=function(){l.queryAll({id:n.doctorId},function(t){var r=e.doctor=t.doctors[0],o={title:"为您推荐一个好大夫： "+r.name,desc:r.hospitalName+" "+r.deptName+" "+r.level+" "+r.teacherLevel+"  擅长："+r.specialty,link:"http://www.yushansoft.com/dingdong/v1/ddpatient/index.html#/doctors/"+r.id+"/doctorInforShare",imgUrl:r.headImgUrl,success:function(){},cancel:function(){},fail:function(e){alert("分享失败，请重新尝试")}};wx.ready(function(){wx.onMenuShareTimeline(o),wx.onMenuShareAppMessage(o)}),e.doctors=t.doctors,d.getDoctorHospitals({doctorId:n.doctorId,status:1},function(t){e.doctor.hospitals=t.doctorHospitals})})},I=function(){g.getDoctorEvaluations({doctorId:n.doctorId,size:3,page:1,order:"createTime",orderBy:"DESC"},function(t){t.doctorEvals&&t.doctorEvals.length>0&&(e.doctorEvals=t.doctorEvals)})};S(),I()}]).controller("newPatientCtrl",["$scope","dateFilter","$location","$ionicHistory","$ionicPopup","$stateParams","$q","doctorUtils","userInforList","ddJsConfig","ddAddYusFilesServices","ddUserServices","yusFilesServices","ddUserDirectRegisterServices","getRegisterByIdServices","userNewQueueServices","getRegisterByStatusServices","registerUpdateServices","showPopupServices","userInforList",function(e,t,r,o,s,n,i,a,c,d,l,u,p,f,g,m,h,v,S,c){var I;c.hasOwnProperty("userId")?I=c.userId:(I=a.getCookies("userId"),c.userId=I);var $=!1;wx.ready(function(e){$=!0}),$||a.wxInit();sessionStorage.getItem("currentDate");e.ctrlScope=e,e.ctrlScope.agree=!0;new Date;e.title="预约",e.revisitList=[{name:"否",value:"N"},{name:"是",value:"Y"}],e.goBack=function(){o.goBack(-1)},e.scheduleDate=n.scheduleDate,e.doctorId=n.doctorId;var y=e.pageStatus=n.type,w=[];e.yusFiles=w;var D=sessionStorage.getItem("registerId");sessionStorage.removeItem("registerId");var b=function(){"registerUpdate"==y?(e.ctrlScope.name=c.register.patientName,e.ctrlScope.phenomenon=c.register.phenomenon,e.ctrlScope.attachNo=c.register.attachNo,e.ctrlScope.revisit=c.register.revisit):"queueUpdate"==y&&(e.ctrlScope.name=c.queue.patientName,e.ctrlScope.phenomenon=c.queue.phenomenon,e.ctrlScope.attachNo=c.queue.attachNo,e.ctrlScope.revisit=c.queue.revisit),e.ctrlScope.attatchNo="",g.get({id:D},function(t){if(TTregister=t.registers[0],TTregister){var r=TTregister.attachUrls;if(e.ctrlScope.attatchNo=TTregister.attatchNo,null!=r&&""!=r){r=r.split(","),e.yusFiles=w=r}else e.yusFiles=null}})};switch(y){case"queueNew":e.title="排队";break;case"queueUpdate":e.title="排队",b();break;case"registerNew":e.title="预约";break;case"registerUpdate":e.title="预约",b()}e.getUserPatient=function(){var e="/userPatientMain/main";r.url(e)};var C=function(e){var t=i.defer();return t.resolve(e),t.promise},U=function(t){wx.uploadImage({localId:t,isShowProgressTips:1,success:function(t){C(t).then(function(t){var r=t.serverId;l.save({},{userId:userId,wxServerId:r},function(t){if("OK"==t.responseDesc){var r=t.yusFiles[0].id;e.ctrlScope.attatchNo?e.ctrlScope.attatchNo=e.ctrlScope.attatchNo+","+r:e.ctrlScope.attatchNo=r}else S.showAlert(t.responseDesc)})})}})};e.wxUpload=function(){w.length<=4&&wx.ready(function(){wx.chooseImage({count:4-w.length,success:function(t){for(var r=t.localIds.length,o=0;r>o;o++){var s=t.localIds[o];U(s),w.push(s)}e.ctrlScope.yusFiles=w,e.$digest()}})})},e.previewImage=function(e){wx.previewImage({current:e,urls:[e]})},e.delImage=function(t){S.showConfirm("",'<h3 style="text-align: center;">删除图片？</h3>',function(){var r=w.indexOf(t);r>-1&&(w.splice(r,1),e.ctrlScope.yusFiles=w)})},e.$on("$ionicView.enter",function(){c.getPatient&&(e.ctrlScope.name=c.getPatient.name,e.ctrlScope.gender=c.getPatient.gender,e.ctrlScope.patientId=c.getPatient.id,e.ctrlScope.userRelation=c.getPatient.userRelation,e.ctrlScope.revisit="N")});var N=function(e){var t=s.alert({template:"<h3>"+e+"</h3>",buttons:[{text:"确定"}]});t.then(function(e){})},P=function(){f.save({userId:userId},{userId:userId,patientId:e.ctrlScope.patientId,scheduleId:n.scheduleId,revisit:e.ctrlScope.revisit,phenomenon:e.ctrlScope.phenomenon,attachNo:e.ctrlScope.attatchNo},function(e){if("309"==e.responseStatus)N("账户余额不足，请及时充值!");else if("400"==e.responseStatus)N("请填写各项内容!");else{N("恭喜您，预约成功!");var t="/tab/user/userRegister";r.url(t)}})},A=function(){m.userQueueUp({userId:userId,patientId:e.ctrlScope.patientId,doctorId:n.doctorId,hospitalId:n.scheduleId,revisit:e.ctrlScope.revisit,phenomenon:e.ctrlScope.phenomenon,attachNo:e.ctrlScope.attatchNo},function(e){if("309"==e.responseStatus)N("账户余额不足，请及时充值!");else if("400"==e.responseStatus)N("请填写各项内容!");else if("OK"==e.responseDesc){N("恭喜您，排队成功!");var t="/tab/user/userQueue";r.url(t)}})},E=function(){D&&v.registerUpdate({id:D,phenomenon:e.ctrlScope.phenomenon,attachNo:e.ctrlScope.attatchNo},function(e){if("309"==e.responseStatus)N("账户余额不足，请及时充值!");else if("400"==e.responseStatus)N("请填写各项内容!");else if("OK"==e.responseDesc)if("queueUpdate"==y){S.showAlert("","修改排队信息成功！");var t="/tab/user/userQueue";r.url(t)}else if("registerUpdate"==y){S.showAlert("","修改预约信息成功！");var t="/tab/user/userRegister";r.url(t)}})};e.showConfirm=function(t){if("registerNew"==y||"queueNew"==y)if(1==e.ctrlScope.agree)if(null==e.ctrlScope.name)N("请选择就诊人!");else{if(!c.doctor)return;if(!c.hospital)return;var r=s.confirm({title:"<h4 >确认"+e.title+"信息</h4>",template:" 您选择的患者是："+e.ctrlScope.name+"<p>身份证号："+c.getPatient.certificateId+"</p><p>医生："+c.doctor.name+"</p><p>医院："+c.hospital.hospitalName+"</p>",cancelText:"取消",okText:"确定"});r.then(function(e){e&&("registerNew"==y?P():"queueNew"==y&&A(),delete c.hospital,delete c.doctor)})}else N("请确认是否同意《叮咚门诊预约挂号服务协议》!");else E()}}]).controller("hospitalCtrl",["$scope","$ionicPopup","$location","$ionicHistory","$stateParams","hospitalServices","ddDoctorHospitalsServices","userQueueServices","userMultiQueueServices","userInforList",function(e,t,r,o,s,n,i,a,c,d){var l=d.userId;i.getDoctorHospitals({doctorId:s.doctorId,status:1},function(t){e.hospitals=t.doctorHospitals}),e.goBack=function(){o.goBack(-1)};var u=[];e.hospitalChanged=function(e,t){if(e)u.push(t.hospitalId);else for(var r=0;r<u.length;r++)if(u[r]==t.hospitalId)return void u.splice(r,1)},e.chk={checked:!0};var p=function(e){var r=t.alert({template:"<h3>"+e+"</h3>",buttons:[{text:"确定"}]});r.then(function(e){})};e.userQueue=function(){return 0==u.length?void p("请选择就诊医院！"):(hospitalStr=u.join(","),void c.save({id:l},{doctorId:s.doctorId,hospitalStr:hospitalStr},function(e){p(e.responseDesc);var t;t="/doctorList",r.url(t)}))}}]).controller("doctorHospitalsCtrl",["$scope","$ionicPopup","$location","$ionicHistory","$stateParams","doctorUtils","ddUserServices","userQueueServices","ddGetDoctorHospitalsWithRegisterInfoServices","doctorInforList","dateFilter","ddGetDoctorScheduleDateServices","userInforList",function(e,t,r,o,s,n,i,a,c,d,l,u,p){var f;p.hasOwnProperty("userId")?f=p.userId:(f=n.getCookies("userId"),p.userId=f);var g=!1;wx.ready(function(e){g=!0}),g||n.wxInit(),c.getDoctorHospitalsWithRegisterInfo({doctorId:s.doctorId,userId:f},function(t){e.hospitals=t.doctorHospitals}),e.goBack=function(){o.goBack(-1)};var m;m=e.doctor=p.doctor;var h={title:"为您推荐一个好大夫： "+m.name,desc:m.hospitalName+" "+m.deptName+" "+m.level+" "+m.teacherLevel+"  擅长："+m.specialty,link:"http://www.yushansoft.com/dingdong/v1/ddpatient/index.html#/doctors/"+m.id+"/doctorInforShare",imgUrl:m.headImgUrl,success:function(){},cancel:function(){},fail:function(e){alert("分享失败，请重新尝试")}};wx.ready(function(){wx.onMenuShareTimeline(h),wx.onMenuShareAppMessage(h)});var v=function(e){var r=t.show({template:e,title:"排队情况",buttons:[{text:"确定"}]});r.then(function(e){})};e.selectHospital=function(t){i.get({userId:f},function(o){var n=e.user=o.users[0];if(n&&n.phone)if(n.balance<t.deposit){v("账户余额不足， 预约该医生的诚意金为"+t.deposit+"元，您账户余额为"+n.balance+"元，请在“个人中心”中充值后再进行预约！");var i="/user/wxpay";r.url(i)}else{var a=t.registerStatus;if("0"==a){p.hospital=t;var i="/newpatient/"+t.hospitalId+"/"+t.doctorId+"/queueNew";r.url(i)}else if("2"==a){var c,f=new Date,g=l(new Date(f.getTime()),"yyyy-MM-dd"),m=l(new Date(f.getTime()+12096e5),"yyyy-MM-dd");u.getDoctorScheduleDate({doctorId:s.doctorId,hospitalId:t.hospitalId,beginDate:g,endDate:m},function(e){var o=e.scheduleList;d.schduleDateList=[],angular.forEach(o,function(e,t,r){d.schduleDateList.push(o[t].scheduleDate)}),p.hospital=t,c="/doctors/"+s.doctorId+"/hospital/"+t.hospitalId,r.url(c)})}}else{v("请先到“我的”菜单，进行进行“手机验证”！");var i="/user/userInformation";r.url(i)}})}}]).controller("userQueueCtrl",["$scope","$rootScope","$ionicPopup","$stateParams","$filter","$location","userQueueServices","dateFilter","userQueueServices","userInforList","ddDeleteQueueServices","getRegisterByStatusServices","userInforList",function(e,t,r,o,s,n,i,a,i,c,d,l,c){var u=c.userId;l.getRegisterByStatus({userId:u,status:-1},function(t){e.queues=c.queues=t.registers,e.queues&&e.queues.length>0?e.showOrNot=!1:e.showOrNot=!0}),e.$on("$ionicView.enter",function(){}),e.queueInfor=function(e){var t="/newpatient/"+e.hospitalId+"/"+e.doctorId+"/queueUpdate";sessionStorage.setItem("registerId",e.id),c.queue=e,n.url(t)};var p=function(e){var t=r.alert({template:"<h3>"+e+"</h3>",buttons:[{text:"确定"}]});t.then(function(e){})};e.remove=function(t){var o='<h4 style=" text-align:center;">'+t.hospitalName+"<br/>"+t.doctorName+"<br/></h4>",s=r.confirm({title:"<h4 >确认取消本次排队吗？</h4>",template:o,cancelText:"取消",okText:"确定"});s.then(function(r){r&&d.deleteQueue({id:t.id},function(r){if("OK"==r.responseDesc){var o=c.queues.filter(function(e,r,o){return e.id!=t.id});c.queues=o,e.queues=c.queues,c.queues.length>0?e.showOrNot=!1:e.showOrNot=!0}else p(r.responseDesc)})})}}]).controller("UserTransferCtrl",["$scope","$timeout","$stateParams","$ionicPopup","$filter","$location","ddUserServices","ddUserTransfersServices","userInforList",function(e,t,r,o,s,n,i,a,c){var d=c.userId;e.ctrlScope=e,e.ctrlScope.showOrNot=!0,e.$on("$ionicView.enter",function(o){var s=function(){i.get({userId:d},function(t){e.user=t.users[0],e.ctrlScope.balance=t.users[0].balance,e.ctrlScope.score=t.users[0].score})},n=e.vm={moredata:!0,doctors:[],pagination:{perPage:15,currentPage:1},init:function(){a.getUserTransfers({userId:d,type:1,size:n.pagination.perPage,page:n.pagination.currentPage},function(t){n.transferList=t.transfers,t.pages<=n.pagination.currentPage+1&&(n.moredata=!1),angular.forEach(n.transferList,function(t,r,o){i.get({userId:o[r].fromUserId},function(t){e.user=t.users[0],"0"==o[r].fromUserId?n.transferList[r].headImgUrl="http://www.yushansoft.com/dingdong/images/sys/score.png":n.transferList[r].headImgUrl=t.users[0].headImgUrl})}),n.transferList&&n.transferList.length>0?e.ctrlScope.showOrNot=!1:e.ctrlScope.showOrNot=!0})},doRefresh:function(){t(function(){s(),a.getUserTransfers({userId:d,type:r.transferType,size:15,page:1},function(t){n.transferList=t.transfers,n.transferList&&n.transferList.length>0?e.ctrlScope.showOrNot=!1:e.ctrlScope.showOrNot=!0}),e.$broadcast("scroll.refreshComplete")},1e3)}};s(),n.init()}),showQueue=function(e){var t=o.alert({template:'<p class="ex1">'+e+"</p>",buttons:[{text:"确定"}]});t.then(function(e){})},e.showConfirme=function(e){showQueue("1）什么是叮咚？<br/>叮咚是叮咚医邦在线给予广大用户的虚拟货币的奖励，可以用于支付，直抵现金。<br/>   2）叮咚折抵现金比例是多少？<br/> 叮咚折抵现金比例是100:1，100叮咚相当于1元人民币。")}}]).controller("UserPatientCtrl",["$scope","$rootScope","$timeout","$ionicPopup","$ionicHistory","$stateParams","$filter","$location","ddUserPatientServices","deleteUserPatientServices","userInforList",function(e,t,r,o,s,n,i,a,c,d,l){var u=l.userId;l.getPatient=null,e.$on("$ionicView.enter",function(){c.getUserPatient({userId:u},function(t){e.patients=t.patients})}),e.getPatient=function(e){l.getPatient=e,"account"==n.type?(url="/userPatientAddAccount/upDate",a.url(url)):s.goBack(-1)},e.goBack=function(){s.goBack(-1)};e.remove=function(t){var r='<h4 style=" text-align:center;">'+t.name+"<br/>"+t.certificateId+"</h4>",s=o.confirm({title:"<h4 >确认删除患者吗？</h4>",template:r,cancelText:"取消",okText:"确定"});s.then(function(r){r&&d.deleteUserPatient({id:t.id},function(t){c.getUserPatient({userId:u},function(t){e.patients=t.patients})})})}}]).controller("UserPatientAddCtrl",["$scope","$rootScope","$ionicPopup","$location","$ionicHistory","$stateParams","$filter","ddUserPatientAddServices","userInforList","ddUserPatientUpdateServices",function(e,t,r,o,s,n,i,a,c,d){var l=c.userId;e.goBack=function(){s.goBack(-1)},e.genderList=[{name:"男",value:0},{name:"女",value:1}],e.revisitList=[{name:"否",value:"N"},{name:"是",value:"Y"}],e.userRelationList=[{name:"本人",value:0},{name:"家庭成员",value:1},{name:"亲戚",value:2},{name:"朋友",value:3},{name:"其他",value:4}];var u=function(e){var t=r.alert({template:"<h3>"+e+"</h3>",buttons:[{text:"确定"}]});t.then(function(e){})};e.patientEditTitle="添加患者",e.ctrlScope=e,c.getPatient&&"upDate"==n.type&&(e.ctrlScope.patientName=c.getPatient.name,e.ctrlScope.certificateId=c.getPatient.certificateId,e.ctrlScope.gender=c.getPatient.gender,e.ctrlScope.phone=c.getPatient.phone,e.ctrlScope.userRelation=c.getPatient.userRelation,e.patientEditTitle="修改患者信息"),
e.showConfirmeAdd=function(t){if(null==e.ctrlScope.patientName||null==e.ctrlScope.userRelation)u("请输完整信息!");else{var o=/^[1-9]{1}[0-9]{14}$|^[1-9]{1}[0-9]{16}([0-9]|[xX])$/;if(o.test(e.ctrlScope.certificateId))if(/^(13[0-9]|14[0-9]|15[0-9]|18[0-9]|17[0-9])\d{8}$/i.test(e.ctrlScope.phone)){var i='<h4 style=" text-align:center;">'+e.ctrlScope.patientName+"<br/>"+e.ctrlScope.certificateId+"</h4>",p=r.confirm({title:"<h4 >确定保存吗？</h4>",template:i,cancelText:"取消",okText:"确定"});p.then(function(t){if(t){var r=null;r={userId:l,patientName:e.ctrlScope.patientName,gender:e.ctrlScope.gender,certificateId:e.ctrlScope.certificateId,userRelation:e.ctrlScope.userRelation,phone:e.ctrlScope.phone},c.getPatient&&"upDate"==n.type?d.userPatientUpdate({id:c.getPatient.id,userId:l,name:e.ctrlScope.patientName,gender:e.ctrlScope.gender,certificateId:e.ctrlScope.certificateId,userRelation:e.ctrlScope.userRelation,phone:e.ctrlScope.phone},function(e){}):a.userPatientAdd({},r),r.name=e.ctrlScope.patientName,c.getPatient=r,s.goBack(-1)}})}else u("请检查手机号是否输入正确!");else u("请检查身份证是否输入正确！")}}}]).controller("EnchashmentCtrl",["$scope","$location","$ionicPopover","$ionicPopup","ddCashApplyServices","doctorInforList",function(e,t,r,o,s,n){e.ctrlScope=e,showQueue=function(e){var t=o.alert({template:"<h3>"+e+"</h3>",buttons:[{text:"确定"}]});t.then(function(e){})},e.getCard=function(){var e="/accountList/getCard";t.url(e)},e.$on("$ionicView.enter",function(){e.ctrlScope.bankName="",e.ctrlScope.cardNumber="",e.ctrlScope.cardName="",n.card&&(e.ctrlScope.bankName=n.card.bankName,e.ctrlScope.cardNumber=n.card.cardNumber,e.ctrlScope.cardName=n.card.cardName)}),e.cashApply=function(r){if(null==e.ctrlScope.bankName||null==e.ctrlScope.cardNumber||null==e.ctrlScope.cardName)showQueue("请补充完各项信息！");else{var i='<h4 style=" text-align:center;">'+e.ctrlScope.bankName+"<br/>"+e.ctrlScope.cardNumber+"<br/>"+e.ctrlScope.cardName+"</h4>",a=o.confirm({title:"<h4 >确定提交取现申请吗？</h4>",template:i,cancelText:"取消",okText:"确定"});a.then(function(r){r&&s.postCashApply({accountId:n.card.id,amount:e.ctrlScope.amount},function(e){showQueue(e.responseDesc);var r="/user/wxpay";t.url(r)})})}}}]).controller("AccountListCtrl",["$scope","$ionicPopup","$timeout","$rootScope","$stateParams","$ionicPopover","$location","$ionicHistory","ddDeleteAccountServices","ddAccountsServices","doctorInforList","userInforList",function(e,t,r,o,s,n,i,a,c,d,l,u){var p=u.userId;e.ctrlScope=e,e.$on("$ionicView.enter",function(t){d.getAccounts({userId:p},function(t){e.ctrlScope.accounts=t.accounts}),e.goBack=function(){a.goBack(-1)},e.ctrlScope.getAccount=function(e){s.operationType&&"getCard"==s.operationType&&(l.card=e,a.goBack(-1))}}),e.doRefresh=function(){r(function(){d.getAccounts({userId:p},function(t){e.ctrlScope.accounts=t.accounts}),e.$broadcast("scroll.refreshComplete")},1e3)},e.showConfirmeAdd=function(e){var t="/addAccount";i.url(t)},e.remove=function(t){c.deleteAccount({id:t.id},function(t){d.getAccounts({userId:p},function(t){e.ctrlScope.accounts=t.accounts})})}}]).controller("AddAccountCtrl",["$scope","$filter","$location","$ionicPopover","$ionicPopup","$stateParams","$ionicHistory","ddAddAccountsServices","userInforList",function(e,t,r,o,s,n,i,a,c){e.ctrlScope=e,e.goBack=function(){i.goBack(-1)};var d=c.userId;e.showConfirmeAdd=function(t){var o='<h4 style=" text-align:center;">'+e.ctrlScope.bankName+"<br/>"+e.ctrlScope.cardNumber+"<br/>"+e.ctrlScope.cardName+"</h4>",n=s.confirm({title:"<h4 >您确定添加如下账户吗？</h4>",template:o,cancelText:"取消",okText:"确定"});n.then(function(t){if(t){var o={accounts:[{bankAddress:e.ctrlScope.bankAddress,bankBranchName:e.ctrlScope.bankBranchName,bankName:e.ctrlScope.bankName,cardName:e.ctrlScope.cardName,cardNumber:e.ctrlScope.cardNumber,userId:d}],requestDesc:"string",requestStatus:0};a.addAccounts({},o);var s="accountList";r.url(s)}})}}]).controller("userRegisterCtrl",["$scope","$rootScope","$ionicPopup","$stateParams","$filter","$location","getRegisterByStatusServices","cancelRegisterServices","userInforList",function(e,t,r,o,s,n,i,a,c){var d=c.userId;i.getRegisterByStatus({userId:d,status:1},function(t){e.registers=c.registers=t.registers,e.registers&&e.registers.length>0?e.showOrNot=!1:e.showOrNot=!0}),e.$on("$ionicView.enter",function(){});var l=function(e){var t=r.alert({template:"<h3>"+e+"</h3>",buttons:[{text:"确定"}]});t.then(function(e){})};e.registerInfor=function(e){var t="/newpatient/"+e.scheduleId+"/"+e.doctorId+"/registerUpdate";c.register=e,sessionStorage.setItem("registerId",e.id),n.url(t)},e.remove=function(t){var o='<h4 style=" text-align:center;">'+t.hospitalName+"<br/>"+t.doctorName+"<br/>"+s("dateFormat1")(t.scheduleDate)+s("timeSlot")(t.timeSlot)+"</h4>",n=r.confirm({title:"<h4 >确认取消本次预约吗？</h4>",template:o,cancelText:"取消",okText:"确定"});n.then(function(r){r&&a.cancelRegister({id:t.id},function(r){if("OK"==r.responseDesc){var o=c.registers.filter(function(e,r,o){return e.id!=t.id});c.registers=o,e.registers=c.registers,e.registers&&e.registers.length>0?e.showOrNot=!1:e.showOrNot=!0}else l(r.responseDesc)})})}}]).controller("PatientDetailCtrl",["$scope","$stateParams","$ionicHistory","$location","$ionicPopup","$filter","getDoctorEvalsByRegisterServices","ddPatientDetailServices","ddRegistersServices",function(e,t,r,o,s,n,a,c,d){c.get({patientId:t.patientId},function(t){e.patient=t.patients[0]}),d.get({id:t.registerId},function(t){if(e.register=t.registers[0],e.register){var r=e.register.attachUrls,o=[];if(null!=r&&""!=r){var s=[];for(s=r.split(","),e.showOrNot=!1,i=0;i<s.length;i++)o.push(s[i])}else e.showOrNot=!0;e.yusFiles=o}}),a.getDoctorEvalsByRegisterId({registerId:t.registerId},function(t){e.doctorEvals=t.doctorEvals}),e.goBack=function(){r.goBack(-1)},showQueue=function(e){var t=s.alert({template:"<h3>"+e+"</h3>",buttons:[{text:"确定"}]});t.then(function(e){})}}]).controller("userRegisterHistoryCtrl",["$scope","$location","$rootScope","$stateParams","getRegisterByStatusServices","userInforList",function(e,t,r,o,s,n){var i=n.userId;s.getRegisterByStatus({userId:i,status:5},function(t){n.registersHistorys=t.registers,e.registersHistorys=n.registersHistorys,e.registersHistorys&&e.registersHistorys.length>0?e.showOrNot=!1:e.showOrNot=!0}),e.$on("$ionicView.enter",function(){})}]).controller("needEvaluationListCtrl",["$scope","$rootScope","$location","$stateParams","getRegisterByStatusServices","userInforList",function(e,t,r,o,s,n){var i=n.userId;s.getRegisterByStatus({userId:i,status:3},function(t){n.needEvaluation=t.registers,e.needEvaluation=n.needEvaluation,e.needEvaluation&&e.needEvaluation.length>0?e.showOrNot=!1:e.showOrNot=!0}),e.$on("$ionicView.enter",function(){}),e.addEvaluate=function(e){var t="/user/addEvaluation/"+e.id;r.url(t)}}]).controller("UserRegisterConfirmListCtrl",["$scope","$rootScope","$timeout","$stateParams","$ionicPopup","$filter","userInforList","userQueueServices","getRegisterByStatusServices","ddConfirmQueueServices","showPopupServices","cancelRegisterServices",function(e,t,r,o,s,n,i,a,c,d,l,u){var p,f=i.userId;c.getRegisterByStatus({userId:f,status:0},function(t){e.registers=p=t.registers,e.registers&&e.registers.length>0?e.showOrNot=!1:e.showOrNot=!0}),e.$on("$ionicView.enter",function(){}),e.doRefresh=function(){r(function(){c.getRegisterByStatus({userId:f,status:0},function(t){e.registers=t.registers}),e.$broadcast("scroll.refreshComplete")},500)},e.registerConfirm=function(t){l.showConfirm("",'<h3 style="text-align: center">确定预约?</h3>',function(){d.ddConfirmQueue({id:t.id},function(r){if("1"==r.responseStatus){l.showAlert("<h3>恭喜您！预约成功！</h3>");var o=p.filter(function(e,r,o){return e.id!=t.id});i=o,e.registers=o,e.registers&&e.registers.length>0?e.showOrNot=!1:e.showOrNot=!0}else l.showAlert("<h3>"+r.responseDesc+"</h3>")})})},e.delRegister=e.remove=function(t){var r='<h4 style=" text-align:center;">'+t.hospitalName+"<br/>"+t.doctorName+"<br/>"+n("dateFormat1")(t.scheduleDate)+n("timeSlot")(t.timeSlot)+"</h4>",o=s.confirm({title:"<h4 >确认取消本次预约吗？</h4>",template:r,cancelText:"取消",okText:"确定"});o.then(function(r){r&&u.cancelRegister({id:t.id},function(r){if("OK"==r.responseDesc){var o=i.registersConfirm.filter(function(e,r,o){return e.id!=t.id});i.registersConfirm=o,e.registers=i.registersConfirm,e.registers&&e.registers.length>0?e.showOrNot=!1:e.showOrNot=!0}else showQueue(r.responseDesc)})})}}]).controller("SmsValidCtrl",["$scope","$filter","$location","$ionicPopover","$ionicPopup","$stateParams","ddUserServices","ddSmsValiServices","ddUpdateSmsValiServices","userInforList",function(e,t,r,o,s,n,i,a,c,d){var l=d.userId;e.ctrlScope=e,i.get({userId:l},function(t){e.user=t.users[0],e.ctrlScope.phoneOld=t.users[0].phone}),e.showConfirmeGetValid=function(t){var r=e.ctrlScope.mobileNo;e.ctrlScope.msgCode;a.validNum({mobileNo:r},function(e){if("OK"==e.responseDesc){var t='<h4 style=" text-align:center;">'+r+"</h4>",o=s.confirm({title:"<h4 >发送至：</h4>",template:t,cancelText:"取消",okText:"确定"});o.then(function(e){})}})},e.showConfirmePutValid=function(t){var o=e.ctrlScope.mobileNo,n=e.ctrlScope.msgCode,a=1;c.updateSmsValid({userId:l,mobileNo:o,msgCode:n,imgCode:a},function(t){if("1"==t.retMap.ok){var n='<h4 style=" text-align:center;">'+o+"</h4>",a=s.confirm({title:"<h4 >验证通过：</h4>",template:n,cancelText:"取消",okText:"确定"});a.then(function(t){if(t){i.get({userId:l},function(t){e.user=t.users[0],e.ctrlScope.phoneOld=t.users[0].phone});var o="/tab/account";r.url(o)}})}else alert(t.retMap.msg)})}}]).controller("ScoreCtrl",["$scope","$ionicPopup","$ionicPopover","ddUserServices","userInforList",function(e,t,r,o,s){var n=s.userId;e.ctrlScope=e,e.$on("$ionicView.enter",function(t){o.get({userId:n},function(t){e.user=t.users[0],e.ctrlScope.score=t.users[0].score})})}]).controller("TermsCtrl",["$scope","$ionicPopup","$ionicHistory","$ionicPopover","$location","ddUserServices","userInforList",function(e,t,r,o,s,n,i){i.userId;e.ctrlScope=e,e.goBack=function(){r.viewHistory().backView?r.goBack(-1):s.url("/tab/main"),r.goBack(-1)},e.$on("$ionicView.enter",function(e){})}]).controller("WxpayCtrl",["$scope","$ionicPopup","$ionicHistory","$stateParams","$timeout","$ionicPopover","$window","ddUserTransfersServices","ddUserServices","userInforList",function(e,t,r,o,s,n,i,a,c,d){var l=d.userId;e.ctrlScope=e;var u=function(){c.get({userId:l},function(t){e.user=t.users[0],e.ctrlScope.balance=t.users[0].balance,e.ctrlScope.score=t.users[0].score})},p=function(){a.getUserTransfers({userId:l,type:0,size:15,page:1},function(t){e.vm.transferList=t.transfers,angular.forEach(e.vm.transferList,function(t,r,o){c.get({userId:o[r].fromUserId},function(t){e.user=t.users[0],"0"==o[r].fromUserId?e.vm.transferList[r].headImgUrl="http://www.yushansoft.com/dingdong/images/sys/money_bag.png":e.vm.transferList[r].headImgUrl=t.users[0].headImgUrl})}),e.vm.transferList&&e.vm.transferList.length>0?e.ctrlScope.showOrNot=!1:e.ctrlScope.showOrNot=!0})};e.goBack=function(){r.goBack(-1)},e.expanderTitle="财富明细",e.vm={},e.$on("$ionicView.enter",function(e){u(),p()}),e.doRefresh=function(){s(function(){u(),p(),e.$broadcast("scroll.refreshComplete")},500)},e.showConfirmeCharge=function(e){var t="http://www.yushansoft.com/dingdong/sys/wxpay/tab-wxpay.html";i.open(t)}}]).controller("WxpayRechargeCtrl",["$scope","$ionicPopup","$ionicHistory","$stateParams","$timeout","$ionicPopover","$window","$ionicHistory","ddUserTransfersServices","ddUserServices","userInforList","ddRechargeServices",function(e,t,r,o,s,n,i,r,a,c,d,l){var u=d.userId;e.ctrlScope=e,e.ctrlScope={totalFee:100},e.userRechargeConfirm=function(){l.postRecharge({userId:u,totalFee:e.ctrlScope.totalFee},function(e){"OK"==e.responseDesc&&WeixinJSBridge.invoke("getBrandWCPayRequest",e.tokenConfig,function(e){"get_brand_wcpay_request:ok"==e.err_msg?r.goBack(-1):alert("微信充值失败,请稍后重试!")})})},e.$on("$ionicView.enter",function(e){})}]).controller("UserInformationCtrl",["$scope","$ionicPopup","$ionicHistory","$location","$ionicPopover","ddUserServices","ddUpdateUserInformationServices","ddUpdateSmsValiServices","ddSmsValiServices","userInforList",function(e,t,r,o,s,n,i,a,c,d){var l=d.userId;e.genderList=[{name:"男",value:0},{name:"女",value:1}],e.ctrlScope=e;var u=60;showQueue=function(e){var r=t.alert({template:"<h3>"+e+"</h3>",buttons:[{text:"确定"}]});r.then(function(e){})},e.goBack=function(){r.goBack(-1)},e.ctrlScope.countdown="获取验证码",e.showConfirmeGetValid=function(t){var r=e.ctrlScope.mobileNo;if(null!=r){c.validNum({mobileNo:r},function(e){}),setTimeout(function(){clearInterval(o),e.ctrlScope.countdown="获取验证码",u=60},61e3);var o=setInterval(function(){"1"==u?(e.ctrlScope.countdown="获取验证码",e.ctrlScope.getValidDisable=!1):(u--,e.ctrlScope.countdown="重新发送（"+u+"）",e.ctrlScope.getValidDisable=!0),e.ctrlScope.$digest()},1e3)}else showQueue("请输入要验证的手机号码！")},e.showConfirmePutValid=function(o){var s=e.ctrlScope.mobileNo,i=e.ctrlScope.msgCode;if(null!=s){var c=1;a.updateSmsValid({userId:l,mobileNo:s,msgCode:i,imgCode:c},function(o){if("1"==o.retMap.ok){var i='<h4 style=" text-align:center;">'+s+"</h4>",a=t.confirm({title:"<h4 >验证通过：</h4>",template:i,cancelText:"取消",okText:"确定"});a.then(function(t){t&&(n.get({userId:l},function(t){var r=t.users[0];r&&(e.user=r,e.ctrlScope.phoneOld=r.phone)}),r.goBack(-1))})}else showQueue(o.retMap.msg)})}else showQueue("请输入要验证的手机号码！")},function(){l&&n.get({userId:l},function(t){var r=t.users[0];r&&(e.user=t.users[0],e.ctrlScope.name=t.users[0].name,e.ctrlScope.address=t.users[0].address,e.ctrlScope.gender=t.users[0].gender,e.ctrlScope.phone=t.users[0].phone,e.ctrlScope.certificateId=t.users[0].certificateId,e.ctrlScope.headImgUrl=t.users[0].headImgUrl,e.ctrlScope.phoneOld=t.users[0].phone)})}(),e.showConfirmeSave=function(r){if(null==e.ctrlScope.name)showQueue("请输入姓名!");else{var s=/^[1-9]{1}[0-9]{14}$|^[1-9]{1}[0-9]{16}([0-9]|[xX])$/;if(s.test(e.ctrlScope.certificateId)){var n='<h4 style=" text-align:center;">'+r+"</h4>",a=t.confirm({title:"<h4 >确定保存吗？</h4>",template:n,cancelText:"取消",okText:"确定"});a.then(function(t){if(t){var r=null;r={name:e.ctrlScope.name,gender:e.ctrlScope.gender,address:e.ctrlScope.address,certificateId:e.ctrlScope.certificateId,headImgUrl:e.ctrlScope.headImgUrl},i.updateUserInformation({id:l},r);var s;s="/tab/account",o.url(s),showQueue("保存成功！")}})}else showQueue("请检查身份证是否输入正确！")}}}]).controller("HospitalsAllCtrl",["$scope","$ionicPopover","$stateParams","$location","$timeout","$ionicHistory","ddHospitalsServices","ddHospitalsAllServices","userInforList",function(e,t,r,o,s,n,i,a,c){c.userId;e.$on("$ionicView.enter",function(e){});var d=e.vm={moredata:!0,hospitals:[],pagination:{perPage:30,currentPage:1},init:function(){a.getAllHospitals({size:d.pagination.perPage,page:d.pagination.currentPage,order:"ASC",orderBy:"name"},function(e){d.hospitals=e.hospitals})},doRefresh:function(){s(function(){e.$broadcast("scroll.refreshComplete")},1e3)},loadMore:function(){d.pagination.currentPage+=1,d.moredata&&a.getAllHospitals({size:d.pagination.perPage,page:d.pagination.currentPage,order:"ASC",orderBy:"name"},function(t){d.hospitals=d.hospitals.concat(t.hospitals),t.hospitals.length<=0&&(d.moredata=!1),e.$broadcast("scroll.infiniteScrollComplete")})}};d.init(),e.goBack=function(){n.goBack(-1)}}]).controller("hospitalDoctorsCtrl",["$scope","$rootScope","$stateParams","$ionicPopover","$location","$timeout","$ionicHistory","doctorServices","ddUserServices","hospitalDoctorsServices","hospitalDeptTreeServices","userInforList",function(e,t,r,o,s,n,i,a,c,d,l,u){u.userId;e.viewStatus=1,e.showSchedule=function(t){e.viewStatus=t},e.$on("$ionicView.enter",function(){}),d.getHospitalDoctors({hospitalId:r.hospitalId},function(t){e.doctors=t.doctorHospitals}),l.get({hospitalId:r.hospitalId,size:50,page:1},function(t){e.hospitalDepts=t.hospitalDepts}),e.toggleGroup=function(t){e.isGroupShown(t)?e.shownGroup=null:e.shownGroup=t},e.isGroupShown=function(t){return e.shownGroup===t},e.goBack=function(){i.goBack(-1)}}]).controller("doctorEvaluationListCtrl",["$scope","$rootScope","$ionicHistory","$ionicPopover","$stateParams","$location","$timeout","doctorServices","ddDoctorEvaluationsServices","userInforList",function(e,t,r,o,s,n,i,a,c,d){d.userId;e.$on("$ionicView.enter",function(t){e.goBack=function(){r.goBack(-1)}});var l=e.vm={moredata:!0,doctorEvals:[],pagination:{perPage:15,currentPage:1},init:function(){c.getDoctorEvaluations({doctorId:s.doctorId,size:l.pagination.perPage,page:l.pagination.currentPage,order:"createTime",orderBy:"DESC"},function(e){l.doctorEvals=e.doctorEvals})},doRefresh:function(){i(function(){e.$broadcast("scroll.refreshComplete")},1e3)},loadMore:function(){l.pagination.currentPage+=1,l.moredata&&c.getDoctorEvaluations({doctorId:s.doctorId,size:l.pagination.perPage,page:l.pagination.currentPage,order:"id",orderBy:"ASC"},function(t){l.doctorEvals=l.doctorEvals.concat(t.doctorEvals),t.doctorEvals&&0==t.doctorEvals.length&&(l.moredata=!1),e.$broadcast("scroll.infiniteScrollComplete")})}};l.init()}]).controller("myEvaluationListCtrl",["$scope","$rootScope","$ionicPopup","$ionicHistory","$ionicPopover","$stateParams","$location","$timeout","doctorServices","cancelEvaluationServices","ddMyEvaluationsServices","ddDoctorEvaluationsServices","userInforList",function(e,t,r,o,s,n,i,a,c,d,l,u,p){p.userId;e.$on("$ionicView.enter",function(t){l.getMyEvaluations({userId:n.userId},function(t){e.doctorEvals=t.doctorEvals}),e.goBack=function(){o.goBack(-1)}}),e.doRefresh=function(){a(function(){l.getMyEvaluations({userId:n.userId},function(t){e.doctorEvals=t.doctorEvals}),e.$broadcast("scroll.refreshComplete")},1e3)},showQueue=function(e){var t=r.alert({template:"<h3>"+e+"</h3>",buttons:[{text:"确定"}]});t.then(function(e){})},e.remove=function(t){var o='<h4 style=" text-align:center;"></h4>',s=r.confirm({title:"<h4 >确认删除本条评论吗？</h4>",template:o,cancelText:"取消",okText:"确定"});s.then(function(r){r&&(d.cancelEvaluation({id:t.id},function(t){l.getMyEvaluations({userId:n.userId},function(t){e.doctorEvals=t.doctorEvals})}),showQueue("成功删除本条评论！"))})},e.addEvaluate=function(e){var t="/tab/user/addEvaluation/"+n.registerId;i.url(t)}}]).controller("hospitalIntroCtrl",["$scope","$stateParams","$ionicHistory","getHosipitalIntroServices",function(e,t,r,o){o.getSingleHosiptal({hospitalId:t.hospitalId},function(t){e.hospital=t.hospitals[0]}),e.goBack=function(){r.goBack(-1)}}]).controller("UserSettingCtrl",["$scope","$stateParams","$ionicHistory","$cookies","$cookieStore","showPopupServices","userInforList",function(e,t,r,o,s,n,i){e.goBack=function(){r.goBack(-1)},e.userSetting=function(){i.hasOwnProperty("userId")&&(delete i.userId,o.remove("userId")),n.showAlert("","清除缓存成功")}}]).controller("addEvaluationCtrl",["$scope","$ionicPopup","$location","$ionicHistory","$timeout","$rootScope","$stateParams","doctorUtils","getDoctorsTagsServices","addEvaluationServices","userInforList",function(e,t,r,o,s,n,i,a,c,d,l){e.ctrlScope=e;var u,p=5,f=5,g=[],m=[];l.hasOwnProperty("userId")?u=l.userId:(u=a.getCookies("userId"),l.userId=u),showQueue=function(e){var r=t.alert({template:"<h3>"+e+"</h3>",buttons:[{text:"确定"}]});r.then(function(e){})},e.goBack=function(){o.viewHistory().backView?o.goBack(-1):r.url("/tab/main"),o.goBack(-1)},c.getDoctorsTags({},function(t){e.tags=t.tagList}),e.getTag=function(e){"button-positive"==this.tagType?(this.tagType="",angular.forEach(g,function(t,r,o){t==e.id&&g.splice(r,1)}),angular.forEach(m,function(t,r,o){t==e.tagName&&m.splice(r,1)})):(this.tagType="button-positive",g.push(e.id),m.push(e.tagName))},e.addEval=function(o){var s=null;if(angular.forEach(g,function(e,t,r){s=null==s?e:s+","+e}),null==p||null==f||null==e.ctrlScope.evalDesc)showQueue("请补充评价信息!");else{var n=t.confirm({title:"",template:'<h4 style=" text-align:center;">评价一旦提交将无法修改，请如实评价！</h4>',cancelText:"取消",okText:"确定"});n.then(function(t){if(t)d.save({},{userId:u,registerId:i.registerId,treatmentEffect:p,serviceAttitude:f,evalDesc:e.ctrlScope.evalDesc,tags:s},function(e){if("OK"==e.responseDesc){showQueue("感谢您的评价，您获得积分:"+e.evalScore+"(咚)！");var t="/tab/user/userRegisterHistory";r.url(t)}else showQueue("您已经对本次诊疗评价过了！")});else{var o="/tab/user/needEvaluationList";r.url(o)}})}},e.max=5,e.ratingValTreatmentEffect=5,e.ratingValServiceAttitude=5,e.hoverValTreatmentEffect=2,e.hoverValServiceAttitude=2,e.readonly=!1,e.onHoverTreatmentEffect=function(t){e.hoverValTreatmentEffect=t,p=t},e.onLeaveTreatmentEffect=function(t){e.hoverValTreatmentEffect=t},e.onChangeTreatmentEffect=function(t){e.ratingValTreatmentEffect=t,p=t},e.onHoverServiceAttitude=function(t){e.hoverValServiceAttitude=t,f=t},e.onLeaveServiceAttitude=function(t){e.hoverValServiceAttitude=t},e.onChangeServiceAttitude=function(t){e.ratingValServiceAttitude=t,f=t}}]);var ddpatientDirectives=angular.module("ddpatientDirectives",["ui.rCalendar"]);ddpatientDirectives.directive("compare",["$ngModel",function(e){return{link:function(e,t,r,o){o.$parsers.unshift(function(e){return""==e||""==r.compare||e==r.compare?o.$setValidity("compare",!0):o.$setValidity("compare",!1),e})}}}]),ddpatientDirectives.directive("ngScroll",[function(){return{link:function(e,t,r,o){$(t).mCustomScrollbar({scrollButtons:{enable:!0}})}}}]),ddpatientDirectives.directive("ddexpander",[function(){return{restrict:"EA",replace:!0,transclude:!0,scope:{expanderTitle:"=expanderTitle"},template:'<div><div class="item item-divider" ng-click="toggle()">{{expanderTitle}}</div><div class="body" ng-show="showMe" ng-transclude></div></div>',link:function(e,t,r){e.showMe=!0,e.toggle=function(){e.showMe=!e.showMe}}}}]),ddpatientDirectives.directive("errSrc",[function(){return{restrict:"EA",replace:!0,link:function(e,t,r){r.ngSrc||r.$set("src",r.errSrc)}}}]),ddpatientDirectives.directive("ddbackbutton",["$ionicHistory",function(e){return{restrict:"EA",replace:!0,transclude:!0,template:'<a  class="button button-icon icon ion-chevron-left" ng-click="goBack()"></a>',link:function(t,r,o,s){t.goBack=function(){e.goBack(-1)}}}}]),ddpatientDirectives.directive("hscroller",["$timeout",function(e){return{restrict:"E",template:'<div class="hscroller" ng-transclude></div>',replace:!0,transclude:!0,compile:function(e,t){return function(e,t,r){t[0];angular.element(t).bind("scroll",function(){t[0].scrollLeft})}}}}]),ddpatientDirectives.directive("hcard",["$rootScope",function(e){return{restrict:"E",template:'<div class="hscroller-card" ng-transclude></div>',replace:!0,transclude:!0,scope:{desc:"@",level:"@",location:"@",image:"@",index:"@",href:"@"},link:function(e,t,r){var o=angular.element('<a href="'+r.href+'" style="padding-left: 22px"> <img class="hscroller-img" src="'+r.image+'"/></a>');t.append(o),t.append('<div class="hscroller-label">'+r.desc+r.level+"<br>"+r.location+"</div>")}}}]),ddpatientDirectives.directive("stringToNumber",[function(){return{require:"ngModel",link:function(e,t,r,o){o.$parsers.push(function(e){return""+e}),o.$formatters.push(function(e){return parseInt(e)})}}}]),ddpatientDirectives.directive("star",[function(){return{restrict:"EACM",scope:{ratingValue:"=",max:"=",readonly:"@",onHover:"=",onLeave:"=",starstyle:"@",starrealstyle:"@",startext:"@"},template:'<ul ng-class="getStarCss()" ng-mouseleave="leave(val)"> <a style="font-size: 0.6em;color: #4d4d4d">{{startext}}</a><li ng-repeat="star in stars" style="margin:1px;display:inline;cursor:pointer;"   ng-class="star" ng-click="click($index + 1)" ng-mouseover="over($index + 1)"   >★</li></ul>',link:function(e,t,r,o){t.css("text-align","center"),e.ratingValue=e.ratingValue||0,e.starstyle=e.starstyle||"rating",e.startext=e.startext||"",e.max=e.max||5,e.starrealstyle=e.starrealstyle||"starsmall",e.click=function(t){e.readonly&&"true"===e.readonly||(e.ratingValue=t)},e.over=function(t){e.readonly&&"true"===e.readonly||e.onHover(t)},e.leave=function(t){e.readonly&&"true"===e.readonly||e.onLeave(t)},e.getStarCss=function(){return e.starstyle},e.getRealStar=function(){return e.starrealstyle};var s=function(){e.stars=[];for(var t=0;t<e.max;t++)e.stars.push({filled:t<e.ratingValue})};s(),e.$watch("ratingValue",function(e,t){t&&s()}),e.$watch("max",function(e,t){t&&s()})}}}]);var ddpatientServices=angular.module("ddpatientServices",["ngResource"]),serverName="www.yushansoft.com";ddpatientServices.factory("userInforList",[function(){return{}}]),ddpatientServices.factory("doctorInforList",[function(){return{}}]),ddpatientServices.factory("doctorUtils",["ddJsConfig",function(e){var t={getCookies:function(e){for(var t=document.cookie,r=t.split("; "),o=0;o<r.length;o++){var s=r[o].split("=");if(e==s[0])return s[1]}return""},wxInit:function(){var t=window.location.href;t=t.substring(0,t.indexOf("#")),e.jsConfig({url:t},function(e){var t=e;wx.config({debug:!1,appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","chooseImage","previewImage","uploadImage","downloadImage","chooseWXPay"]})})}};return t}]),ddpatientServices.factory("doctorServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/doctors/:id",null,{queryAll:{method:"get",params:{size:"@size",page:"@number",orderBy:"@orderBy",order:"@order"},isArray:!1}})}]),ddpatientServices.factory("doctorRegisteredServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/doctors/status",null,{queryAll:{method:"get",params:{status:"@status"},isArray:!1}})}]),ddpatientServices.factory("doctorNewJoinServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/doctors/newJoinDoctors",null,{queryAll:{method:"get",params:{requireNum:"@requireNum"},isArray:!1}})}]),ddpatientServices.factory("doctorDeptDoctorsServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/depts/:id/recursiveDoctors",{id:"@id"},{queryAll:{method:"get",params:{},isArray:!1}})}]),ddpatientServices.factory("scheduleServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/doctors/:id/scheduleDates",null,{query:{method:"get",params:{beginDate:"@beginDate",endDate:"@endDate"},isArray:!1}})}]),ddpatientServices.factory("scheduleOnedayServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/doctors/:doctorId/hospitals/:hospitalId/schedules",null,{query:{method:"get",params:{beginDate:"@beginDate",endDate:"@endDate"},isArray:!1}})}]),ddpatientServices.factory("scheduleDatesServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/doctors/:doctorId/hospitals/:hospitalId/scheduleDates",null,{query:{method:"get",params:{beginDate:"@beginDate",endDate:"@endDate"},isArray:!1}})}]),ddpatientServices.factory("scheduleUserServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/users/:userId/schedules/:scheduleId/registers",null,{getScheduleUser:{method:"get",params:{userId:"@userId",scheduleId:"@scheduleId"},isArray:!1}})}]),ddpatientServices.factory("cancelUserFansServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/users/:userId/doctorFans",null,{cancelUserFans:{method:"DELETE",params:{userId:"@userId",doctorId:"@doctorId"},isArray:!1}})}]),ddpatientServices.factory("userFansServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/users/:id/doctorFans",{id:"@id",doctorId:"@doctorId"})}]),ddpatientServices.factory("userQueueServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/users/:id/queues",{id:"@id",doctorId:"@doctorId",hospitalId:"@hospitalId"})}]),ddpatientServices.factory("userNewQueueServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/registers/queueUp",{},{userQueueUp:{method:"POST",params:{userId:"@userId",patientId:"@patientId",doctorId:"@doctorId",hospitalId:"@hospitalId",revisit:"@revisit",phenomenon:"@phenomenon",attachNo:"@attachNo"},isArray:!1}})}]),ddpatientServices.factory("userMultiQueueServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/users/:id/mutiQueueUp",{id:"@id",doctorId:"@doctorId",hospitalStr:"@hospitalStr"})}]),ddpatientServices.factory("hospitalServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/docotors/:id/doctorHospitals",{id:"@id"})}]),ddpatientServices.factory("registerUpdateServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/registers/:id",{},{registerUpdate:{method:"PATCH",params:{id:"@id",phenomenon:"@phenomenon",attachNo:"@attachNo"},isArray:!1}})}]),ddpatientServices.factory("hospitalDoctorsServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/hospitals/:hospitalId/doctorHospitals",{},{getHospitalDoctors:{method:"GET",params:{hospitalId:"@hospitalId"},isArray:!1}})}]),ddpatientServices.factory("registerUnFinishedServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/users/:id/registers/unfinished",{id:"@id"})}]),ddpatientServices.factory("getRegisterByStatusServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/users/:userId/registers/status",{userId:"@userId"},{getRegisterByStatus:{method:"GET",params:{status:"@status"},isArray:!1}})}]),ddpatientServices.factory("cancelRegisterServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/registers/:id",{id:"@id"},{cancelRegister:{method:"DELETE",params:{}}})}]),ddpatientServices.factory("getRegisterByIdServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/registers/:id",{id:"@id"},{})}]),ddpatientServices.factory("ddDeleteQueueServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/registers/queues/:id",{id:"@id"},{deleteQueue:{method:"DElETE",params:{}}})}]),ddpatientServices.factory("ddSmsValiServices",["$resource","$http","$q",function(e){return e("http://"+serverName+"/dingdong/sms/validNum",{},{validNum:{method:"GET",params:{mobileNo:"@mobileNo"},isArray:!1}})}]),ddpatientServices.factory("ddUpdateSmsValiServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/sms/validation",null,{updateSmsValid:{method:"PUT",params:{userId:"@userId",mobileNo:"@mobileNo",msgCode:"@msgCode",imgCode:"@imgCode"}}})}]),ddpatientServices.factory("ddUserServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/users/:userId",{userId:"@userId"},{})}]),ddpatientServices.factory("ddUserRegisterServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/users/:userId/registers",{userId:"@userId"},{userRegister:{method:"POST",params:{patientId:"@patientId",scheduleId:"@scheduleId"},isArray:!1}})}]),ddpatientServices.factory("ddUpdateUserInformationServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/users/:id",{id:"@id"},{updateUserInformation:{method:"PUT",params:{name:"@name",gender:"@gender",address:"@address",certificateId:"@certificateId",headImgUrl:"@headImgUrl"}}})}]),ddpatientServices.factory("ddUserDirectRegisterServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/users/:userId/directRegister",{userId:"@userId",patientId:"@patientId",scheduleId:"@scheduleId",phenomenon:"@phenomenon",revisit:"@revisit",attachNo:"@attachNo"})}]),ddpatientServices.factory("ddUserConfirmRegisterServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/users/{userId}/confirmRegister",{registerId:"@registerId",patientId:"@patientId",phenomenon:"@phenomenon",revisit:"@revisit",attachNo:"@attachNo"})}]),ddpatientServices.factory("ddGetRegistersByStatusServices",["$resource","$http",function(e){return e("http://"+serverName+"/dingdong/users/:userId/registers/status",{userId:"@userId"},{getRegistersByStatus:{method:"GET",params:{status:"@status"},isArray:!1}})}]),ddpatientServices.factory("ddGetDoctorsByNameOrSpecialty",["$resource","$http",function(e){return e("http://"+serverName+"/dingdong/doctors",{},{getDoctorsByNameOrSpecialty:{method:"GET",params:{filterText:"@filterText",size:"@size",page:"@page",order:"@order",orderBy:"@orderBy"},isArray:!1}})}]),
ddpatientServices.factory("ddGetDoctorsnsigned",["$resource","$http",function(e){return e("http://"+serverName+"/dingdong/doctors/unsigned",{},{getGetDoctorsnsigned:{method:"GET",params:{doctorName:"@doctorName"},isArray:!1}})}]),ddpatientServices.factory("ddHospitalsServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/hospitals",{},{getHospitals:{method:"GET",params:{filterText:"@filterText",size:"@size",page:"@page",orderBy:"@orderBy",order:"@order"},isArray:!1}})}]),ddpatientServices.factory("ddHospitalsAllServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/hospitals",{},{getAllHospitals:{method:"GET",params:{size:"@size",page:"@page",orderBy:"@orderBy",order:"@order"},isArray:!1}})}]),ddpatientServices.factory("ddConfirmQueueServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/registers/:id/confirmQueue",{id:"@id"},{ddConfirmQueue:{method:"POST",params:{},isArray:!1}})}]),ddpatientServices.factory("ddDoctorHospitalsServices",["$resource","$http","$q",function(e){return e("http://"+serverName+"/dingdong/docotors/:doctorId/doctorHospitals",{},{getDoctorHospitals:{method:"GET",params:{doctorId:"@doctorId",status:"@status"},isArray:!1}})}]),ddpatientServices.factory("ddDoctorEvaluationsServices",["$resource","$http","$q",function(e){return e("http://"+serverName+"/dingdong/docotors/:doctorId/doctorEvals",{},{getDoctorEvaluations:{method:"GET",params:{doctorId:"@doctorId",size:"@size",page:"@page",order:"@order",orderBy:"@orderBy"},isArray:!1}})}]),ddpatientServices.factory("ddMyEvaluationsServices",["$resource","$http","$q",function(e){return e("http://"+serverName+"/dingdong/users/:userId/doctorEvals",{},{getMyEvaluations:{method:"GET",params:{userId:"@userId"},isArray:!1}})}]),ddpatientServices.factory("ddUserPatientServices",["$resource","$http","$q",function(e){return e("http://"+serverName+"/dingdong/users/:userId/patients",{},{getUserPatient:{method:"GET",params:{userId:"@userId"},isArray:!1}})}]),ddpatientServices.factory("cancelEvaluationServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/doctorEvals/:id",{id:"@id"},{cancelEvaluation:{method:"DELETE",params:{}}})}]),ddpatientServices.factory("addEvaluationServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/users/:userId/doctorEval",{userId:"@userId",registerId:"@registerId",treatmentEffect:"@treatmentEffect",serviceAttitude:"@serviceAttitude",evalDesc:"@evalDesc",tags:"@tags"})}]),ddpatientServices.factory("yusFilesServices",["$resource","$http","$q",function(e){return e("http://"+serverName+"/dingdong/yusFiles/:id",{id:"@id"},{})}]),ddpatientServices.factory("ddAddYusFilesServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/yusFiles",{userId:"@userId",wxServerId:"@wxServerId"})}]),ddpatientServices.factory("ddUserPatientAddServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/users/:userId/patients",{userId:"@userId"},{userPatientAdd:{method:"POST",params:{patientName:"@patientName",gender:"@gender",certificateId:"@certificateId",userRelation:"@userRelation",phone:"@phone"},isArray:!1}})}]),ddpatientServices.factory("deleteUserPatientServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/patients/:id",{id:"@id"},{deleteUserPatient:{method:"DELETE",params:{}}})}]),ddpatientServices.factory("getUserPatientServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/patients/:id",{id:"@id"},{getUserPatient:{method:"GET",params:{},isArray:!1}})}]),ddpatientServices.factory("ddUserPatientUpdateServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/patients/:id",{id:"@id"},{userPatientUpdate:{method:"PUT",params:{userId:"@userId",name:"@name",certificateId:"@certificateId",userRelation:"@userRelation",gender:"@gender",birthday:"@birthday",phone:"@phone",address:"@address"},isArray:!1}})}]),ddpatientServices.factory("ddPatientHistoryServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/doctors/:id/registers/status",{id:"@id"},{queryHistory_Registers:{method:"GET",params:{},isArray:!1}})}]),ddpatientServices.factory("ddGetDoctorQueuesServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/doctors/:doctorId/statQueue",{doctorId:"@doctorId"},{getDoctorQueues:{method:"GET",params:{},isArray:!1}})}]),ddpatientServices.factory("ddJsConfig",["$resource","$http","$q",function(e){return e("http://"+serverName+"/dingdong/ddmz/jsConfig",{},{jsConfig:{method:"GET",params:{url:"@url"},isArray:!1}})}]),ddpatientServices.factory("ddGetDoctorScheduleDateServices",["$resource","$http","$q",function(e){return e("http://"+serverName+"/dingdong/doctors/:doctorId/hospitals/:hospitalId/schedules",{doctorId:"@doctorId",hospitalId:"@hospitalId"},{getDoctorScheduleDate:{method:"GET",params:{beginDate:"@beginDate",endDate:"@endDate"},isArray:!1}})}]),ddpatientServices.factory("ddGetDoctorHospitalsWithRegisterInfoServices",["$resource","$http","$q",function(e){return e("http://"+serverName+"/dingdong/docotors/:doctorId/doctorHospitalsWithRegisterInfo",{doctorId:"@doctorId"},{getDoctorHospitalsWithRegisterInfo:{method:"GET",params:{userId:"@userId"},isArray:!1}})}]),ddpatientServices.factory("userChatService",["$resource","$http","$q",function(e){return e("http://"+serverName+"/dingdong/userChat/:fromId",{},{})}]),ddpatientServices.factory("ddUserTransfersServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/users/:userId/Transfers",{userId:"@userId"},{getUserTransfers:{method:"GET",params:{type:"@type",size:"@size",page:"@page"},isArray:!1}})}]),ddpatientServices.factory("ddUserChatAllServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/users/:userId/msgs/:endDate",{userId:"@userId"},{method:"GET",params:{size:"@size",page:"@page"},isArray:!1})}]),ddpatientServices.factory("ddUserTwoUserMsgs",["$resource",function(e){return e("http://"+serverName+"/dingdong/msgs",{userId:"@userId"},{method:"GET",params:{fromUserId:"fromUserId",toUserId:"toUserId",size:"@size",page:"@page"},isArray:!1})}]),ddpatientServices.factory("ddUserReadMsgs",["$resource",function(e){return e("http://"+serverName+"/dingdong/msgs/:toId/read",{toId:"@toId"},{readMsgs:{method:"PATCH",params:{},isArray:!1}})}]),ddpatientServices.factory("ddRegistersServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/registers/:id",{id:"@id"},{})}]),ddpatientServices.factory("ddPatientDetailServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/patients/:patientId",{patientId:"@patientId"},{})}]),ddpatientServices.factory("getDoctorEvalsByRegisterServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/registers/:registerId/doctorEvals",{registerId:"@registerId"},{getDoctorEvalsByRegisterId:{method:"GET",params:{},isArray:!1}})}]),ddpatientServices.factory("hospitalDeptTreeServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/hospitalDepts/:hospitalId/tree",{registerId:"@registerId"},{method:"GET",params:{hospitalId:"@hospitalId",size:"@size",page:"@page"},isArray:!1})}]),ddpatientServices.factory("topDeptServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/depts/topDepts",{},{method:"GET",params:{},isArray:!1})}]),ddpatientServices.factory("subDeptServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/depts/:parentId/subDepts",{parentId:"@parentId"},{method:"GET",params:{},isArray:!1})}]),ddpatientServices.factory("allDeptServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/depts",{},{method:"GET",params:{filterText:"@filterText",size:"@size",page:"@page",order:"@order",orderBy:"orderBy"},isArray:!1})}]),ddpatientServices.factory("getDoctorsTagsServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/systag/tags",{},{getDoctorsTags:{method:"GET",params:{},isArray:!1}})}]),ddpatientServices.factory("getHosipitalIntroServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/hospitals/:hospitalId",{},{getSingleHosiptal:{method:"GET",params:{hospitalId:"@hospitalId"},isArray:!1}})}]),ddpatientServices.factory("ddAccountsServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/accounts/:userId/userId",{userId:"@userId"},{getAccounts:{method:"GET",params:{},isArray:!1}})}]),ddpatientServices.factory("ddDeleteAccountServices",["$resource","$q",function(e,t){return e("http://"+serverName+"/dingdong/accounts/:id",null,{deleteAccount:{method:"DElETE",params:{id:"@id"}}})}]),ddpatientServices.factory("ddAddAccountsServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/accounts",null,{addAccounts:{method:"POST"}})}]),ddpatientServices.factory("ddCashApplyServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/transfers/getCashApply",{},{postCashApply:{method:"POST",params:{accountId:"@accountId",amount:"@amount"}}})}]),ddpatientServices.factory("ddRechargeServices",["$resource",function(e){return e("http://"+serverName+"/dingdong/ddmz/payToken",{},{postRecharge:{method:"GET",params:{userId:"@userId",totalFee:"@totalFee"}}})}]),ddpatientServices.factory("showPopupServices",["$ionicPopup",function(e){var t={showPopup:function(){var t=e.show({template:'<input type="password" ng-model="data.wifi">',title:"Enter Wi-Fi Password",subTitle:"Please use normal things",scope:$scope,buttons:[{text:"取消"},{text:"<b>确定</b>",type:"button-stable",onTap:function(e){return $scope.data.wifi?$scope.data.wifi:void e.preventDefault()}}]});t.then(function(e){console.log("Tapped!",e)}),$timeout(function(){t.close()},3e3)},showConfirm:function(t,r,o){var s=e.confirm({title:t,template:r,cancelText:"取消",okText:"确定"});s.then(function(e){e&&o()})},showAlert:function(t,r){var o=e.alert({title:t,template:r,buttons:[{text:"确定"}]});o.then(function(e){})}};return t}]);var ddpatientFilters=angular.module("ddpatientFilters",[]);ddpatientFilters.filter("titleCase",[function(){var e=function(e){for(var t=e.split(" "),r=0;r<t.length;r++)t[r]=t[r].charAt(0).toUpperCase()+t[r].slice(1);return t.join(" ")};return e}]),ddpatientFilters.filter("dateTranfer",[function(){var e=function(e){var t=new Date(e),r=t.getMonth()+1,o=t.getFullYear()+"年"+r+"月"+t.getDate()+"日星期"+"日一二三四五六".charAt(t.getDay())+"<br/><br/>";return o};return e}]),ddpatientFilters.filter("dateForOrder",[function(){var e=function(e){for(var t=[],r=0;r<e.length;r++){var o=new Date(e[r]),s=new Date(o.getFullYear()+"-"+(o.getMonth()+1)+"-"+(o.getDate()+1));t.push({startTime:s,endTime:s,allDay:!0})}return t};return e}]),ddpatientFilters.filter("gender",[function(){var e=function(e){var t="男";return"1"==e&&(t="女"),t};return e}]),ddpatientFilters.filter("dateFormat1",[function(){var e=function(e){var t=new Date(e),r=t.getFullYear(),o=t.getMonth()+1,s=t.getDate(),n=r+"."+o+"."+s;return n};return e}]),ddpatientFilters.filter("ageFormat",[function(){var e=function(e){var t=new Date,r=new Date(e),o=t.getFullYear()-r.getFullYear();return o};return e}]),ddpatientFilters.filter("registerStatus",[function(){var e=function(e){var t="排队中";return"0"==e?t="草稿":"1"==e?t="已预约":"2"==e?t="已挂号":"3"==e?t="已诊疗":"4"==e?t="已取消":"5"==e&&(t="已评价"),t};return e}]),ddpatientFilters.filter("timeSlot",[function(){var e=function(e){var t="全天";return"1"==e?t="上午":"2"==e?t="下午":"3"==e&&(t="晚上"),t};return e}]),ddpatientFilters.filter("namePart",[function(){var e=function(e){var t=e.substring(0,1);return t?t+"**":"***"};return e}]),ddpatientFilters.filter("doctorHospitalsStatus",[function(){var e=function(e){var t="号满排队";return"0"==e?t=" 号满排队":"1"==e?t="已经排队":"2"==e?t="预约挂号":"3"==e&&(t="已经挂号"),t};return e}]),ddpatientFilters.filter("doctorStatus",[function(){var e=function(e){var t="可预约";return t="1"==e?" 可预约":"可排队"};return e}]),ddpatientFilters.filter("fontColorFilter",[function(){var e=function(e){var t="color:green";return t="挂号诚意金"==e?"color:black":"诊疗后退款"==e?"color:blue":"color:green"};return e}]),ddpatientFilters.filter("cut",[function(){return function(e,t,r,o){if(!e)return"";if(r=parseInt(r,10),!r)return e;if(e.length<=r)return e;if(e=e.substr(0,r),t){var s=e.lastIndexOf(" ");-1!=s&&(e=e.substr(0,s))}return e+(o||" …")}}]),ddpatientFilters.filter("transferStatus",[function(){var e=function(e){var t="";return"0"==e&&(t="(交易中)"),t};return e}]);var ddChatController=angular.module("ddChatController",["ionic"]);ddChatController.controller("ChatRoomCtrl",["$scope","$rootScope","$ionicActionSheet","$ionicPopup","$ionicScrollDelegate","$timeout","$interval","$stateParams","$q","$filter","$location","$ionicHistory","$rootScope","doctorServices","userChatService","ddUserChatAllServices",function(e,t,r,o,s,n,i,a,c,d,l,u,t,p,f,g){function m(){var e=c.defer();return f.get({fromId:S},function(t){e.resolve(t)}),e.promise}function h(){"WebSocket"in window?(y=new WebSocket("ws://www.yushansoft.com/dingdong/websck"),console.log("ws://www.yushansoft.com/dingdong/websck")):(y=new SockJS("http://www.yushansoft.com/dingdong/websck/sockjs"),console.log("http://www.yushansoft.com/dingdong/websck/sockjs")),y.onopen=function(e){console.log("WebSocket:已连接"),console.log(e)},y.onmessage=function(e){var t=JSON.parse(e.data);D.msgs.push(t),console.log("WebSocket:收到一条消息",t)},y.onclose=function(e){console.log("Info: connection closed."),console.log(e)},y.onerror=function(e){console.log("WebSocket:发生错误 "),console.log(e)}}function v(){null!=y&&(y.close(),y=null),t.websocket&&(t.websocket.close(),t.websocket=null)}var S=localStorage.getItem("ddUserId");e.ctrlScope=e;var I=new Date,$=new Date(I.getTime()-15552e6),y=null,w=e.vmDoctor={moredata:!0,doctors:[],pagination:{perPage:30,currentPage:1},init:function(){p.queryAll({size:w.pagination.perPage,page:w.pagination.currentPage,orderBy:"name",order:"ASC"},function(e){w.doctors=e.doctors,e.pages<=w.pagination.currentPage+1&&(w.moredata=!1)})},doRefresh:function(){n(function(){e.$broadcast("scroll.refreshComplete")},1e3)},loadMore:function(){w.pagination.currentPage+=1,w.moreDoctors&&p.queryAll({size:w.pagination.perPage,page:w.pagination.currentPage,orderBy:"name",order:"ASC"},function(t){w.doctors=w.doctors.concat(t.doctors),t.pages<=vm.pagination.currentPage+1&&(w.moredata=!1),e.$broadcast("scroll.infiniteScrollComplete")})}},D=e.vmMsg={moredata:!0,msgs:[],pagination:{perPage:30,currentPage:1},init:function(){g.get({userId:S,endDate:d("date")($,"yyyy-MM-dd"),size:D.pagination.perPage,page:D.pagination.currentPage},function(e){D.msgs=e.msgs,e.pages<=D.pagination.currentPage+1&&(D.moredata=!1)})},doRefresh:function(){n(function(){e.$broadcast("scroll.refreshComplete")},1e3)},loadMore:function(){D.pagination.currentPage+=1,D.moreMsgs&&1==e.viewStatus&&g.get({userId:S,endDate:d("date")($,"yyyy-MM-dd"),size:D.pagination.perPage,page:D.pagination.currentPage},function(t){D.msgs=D.msgs.concat(t.msgs),t.pages<=D.pagination.currentPage+1&&(D.moredata=!1),e.$broadcast("scroll.infiniteScrollComplete")})}};D.init(),w.init(),e.showSchedule=function(t){e.viewStatus=t},e.$on("$ionicView.enter",function(r){e.viewStatus=1;var o=m();o.then(function(){y||h()}).then(function(){t.websocket=y}),messageCheckTimer=i(function(){},1e3)}),e.chatIn=function(e){sessionStorage.setItem("toUserHeadImgUrl",e.fromUserHeadImgUrl),sessionStorage.setItem("toUserId",e.fromUserId),sessionStorage.setItem("toUserName",e.fromUserName),sessionStorage.setItem("endDate",d("date")($,"yyyy-MM-dd"));var t="/userChat/"+S+"/"+e.fromUserId;l.url(t)},e.chatIn_Doctor=function(e){sessionStorage.setItem("toUserHeadImgUrl",e.headImgUrl),sessionStorage.setItem("toUserId",e.id),sessionStorage.setItem("toUserName",e.name),sessionStorage.setItem("endDate",d("date")($,"yyyy-MM-dd"));var t="/userChat/"+S+"/"+e.id;l.url(t)},e.goBack=function(){v(),u.goBack(-1)},e.$on("$ionicView.beforeLeave",function(e){})}]),ddChatController.controller("ChatMessagesCtrl",["$scope","$rootScope","$ionicActionSheet","$ionicPopup","$ionicScrollDelegate","$timeout","$interval","$stateParams","$q","$rootScope","doctorServices","ddUserTwoUserMsgs","ddUserReadMsgs",function(e,t,r,o,s,n,i,a,c,t,d,l,u){function p(){console.log("keepKeyboardOpen"),h.one("blur",function(){console.log("textarea blur, focus back on it"),h[0].focus()})}var f=localStorage.getItem("ddUserId"),g=a.doctorId,m=[];e.messages=m;var h,v=s.$getByHandle("userMessageScroll"),S=t.websocket;S.onmessage=function(t){var r=JSON.parse(t.data);e.messages.push(r),console.log("WebSocket:收到一条消息",r)},e.user={id:f,headImgUrl:"http://ionicframework.com/img/docs/mcfly.jpg",name:"Marty"},e.toUser={id:sessionStorage.getItem("toUserId"),headImgUrl:sessionStorage.getItem("toUserHeadImgUrl"),name:sessionStorage.getItem("toUserName")},e.$watch("input.message",function(e,t){console.log("input.message $watch, newValue "+e)}),l.get({fromUserId:sessionStorage.getItem("toUserId"),toUserId:f,endDate:sessionStorage.getItem("endDate"),size:30,page:1},function(t){console.log(t),angular.forEach(t.msgs,function(t,r,o){e.messages.push(t)})}),e.onMessageHold=function(t,o,s){console.log("message: "+JSON.stringify(s,null,2)),r.show({buttons:[{text:"复制信息"},{text:"删除信息"}],buttonClicked:function(t){switch(t){case 0:break;case 1:e.messages.splice(o,1),n(function(){v.resize()},0)}return!0}})},e.viewProfile=function(t){t.userId===e.user._id},e.sendMessage=function(){var t={toUserId:g,content:e.input.message};p(),t.fromUserId=f,S.send(JSON.stringify(t)),e.messages.push(t),e.input.message="",n(function(){p(),v.scrollBottom(!0)},0),n(function(){p(),v.scrollBottom(!0)},1e3)},e.$on("$ionicView.enter",function(e){n(function(){footerBar=document.body.querySelector("#userMessagesView .bar-footer"),scroller=document.body.querySelector("#userMessagesView .scroll-content"),h=angular.element(footerBar.querySelector("textarea"))},0),messageCheckTimer=i(function(){},1e3)}),e.$on("$ionicView.beforeLeave",function(e){sessionStorage.removeItem("toUserId"),sessionStorage.removeItem("toUserHeadImgUrl"),sessionStorage.removeItem("toUserName"),sessionStorage.removeItem("endDate"),u.readMsgs({toId:f},function(e){console.log("消息已阅！")})})}]);